{% import 'components/input.html' as input %}
{% import 'components/button.html' as buttton %}
{% extends 'layout/base.html' %} {% block title %}Solicitudes{% endblock %} {%
block content %}

<div class="max-w-[var(--container-width)] w-full bg-ligth-500 shadow-md rounded-lg p-6">
  <h1 class="text-2xl font-bold text-gray-800 mb-4">
    Solicitudes de Citas Médicas
  </h1>

  <form method="get" class="mb-4 flex justify-between items-center gap-2 w-full">
    <div class="flex gap-4">
      {{ input.input_field('nombre', type='text', placeholder='nombre del paciente',label='Buscar por nombre') }}
      {{ input.input_field('fecha_inicio', type='date',label='Fecha de Inicio') }}
      {{ input.input_field('fecha_fin', type='date',label='Fecha de Fin') }}
      <div class="flex justify-center items-center gap-2 pt-5">
        <input type="checkbox" id="procesados" name="atendidos" />
        <label for="procesados" name="atendidos">Mostrar Procesados</label>
      </div>
    </div>
    <div class="flex gap-2">
      {{ buttton.button_field('Filtrar') }}
      <a href="/solicitudes"
        class="bg-primary-300 hover:bg-primary-500 text-white px-4 py-2 rounded-lg flex justify-center items-center cursor-pointer">
        Refrescar
      </a>
    </div>
  </form>

  <div class="overflow-x-auto rounded-lg">

    <table class="min-w-full rounded-lg">
      <thead class="bg-primary-hover">
        <tr class="text-primary-500">
          <!-- <th class="px-4 py-2 border">ID</th> -->
          <th class="px-36 py-3">Nombres</th>
          <th class="px-4 py-3 text-start">Especialidad</th>
          <th class="px-4 py-3 text-start">Documento</th>
          <th class="px-4 py-3 text-start">Email</th>
          <th class="px-4 py-3 text-start">Teléfono</th>
          <th class="px-4 py-3 text-start">Continuador</th>
          <th class="px-4 py-3 text-start">SIS</th>
          <th class="px-4 py-3 text-start">Interconsulta</th>
          <th class="px-4 py-3">Estado</th>
          <th class="px-4 py-3 text-start">Fecha</th>
          <th class="px-4 py-3">Opciones</th>
        </tr>
      </thead>
      <tbody>
        {% for solicitud in solicitudes %}
        <tr class="hover:bg-gray-50">
          <!-- <td class="px-4 py-2 border">{{ solicitud.solicitud_id }}</td> -->
          <td class="px-3 py-1.5 border-b-1 border-dashed">{{ solicitud.nombres }}</td>
          <td class="px-3 py-1.5 border-b-1 border-dashed">{{ solicitud.especialidad_nombre }}</td>
          <td class="px-3 py-1.5 border-b-1 border-dashed">{{ solicitud.numero_documento }}</td>
          <td class="px-3 py-1.5 border-b-1 border-dashed">{{ solicitud.email }}</td>
          <td class="px-3 py-1.5 border-b-1 border-dashed">{{ solicitud.telefono }}</td>
          <td class="px-3 py-1.5 border-b-1 border-dashed text-center">
            {% if solicitud.continuador == 1 %} SI {% else %} NO {% endif %}
          </td>
          <td class="px-3 py-1.5 border-b-1 border-dashed text-center">
            {% if solicitud.sis %} SI {% else %} NO {% endif %}
          </td>
          <td class="px-3 py-1.5 border-b-1 border-dashed text-center">
            {% if solicitud.interconsulta %} SI {% else %} NO {% endif %}
          </td>
          <td class="px-3 py-1.5 border-b-1 border-dashed text-center">
            {% if solicitud.estado_solicitud_id == 1 %} PENDIENTE {% elif
            solicitud.estado_solicitud_id == 2 %} ACEPTADO {% elif
            solicitud.estado_solicitud_id == 3 %} RECHAZADO {% endif %}
          </td>
          <td class="px-3 py-1.5 border-b-1 border-dashed">
            {{ solicitud.created_at.strftime('%d/%m/%Y') if solicitud.created_at
            else '' }}
          </td>
          <td class="px-3 py-1.5 border-b-1 border-dashed">
            {% if solicitud.estado_solicitud_id == 2 or
            solicitud.estado_solicitud_id == 3%}
            <div class="flex justify-between items-center gap-2">
              <button type="button" class="text-sm bg-disabled text-white px-3 py-2 rounded-lg cursor-not-allowed"
                disabled>
                Aceptar
              </button>

              <button type="button" class="text-sm bg-disabled text-white px-3 py-2 rounded-lg cursor-not-allowed"
                disabled>
                Rechazar
              </button>
            </div>
            {% elif solicitud.estado_solicitud_id == 1 %}
            <div class="flex justify-between items-center gap-2">
              <button type="button"
                class="text-sm bg-success hover:bg-hover-success text-white px-3 py-2 rounded-lg cursor-pointer"
                onclick="openModal('{{ solicitud.solicitud_id }}')">
                Aceptar
              </button>

              <button type="button"
                class="text-sm bg-danger hover:bg-danger-hover text-white px-3 py-2 rounded-lg cursor-pointer"
                onclick="openModalReject('{{ solicitud.solicitud_id }}')">
                Rechazar
              </button>
            </div>
            {% endif %}
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="11" class="text-center py-4 text-gray-500">
            No hay solicitudes registradas.
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>


    {% for s in solicitudes %}
    <!-- Modal Aceptar -->
    <div id="modal-{{ s.solicitud_id }}" class="hidden" style="
        position: fixed;
        inset: 0;
        background-color: rgba(31, 41, 55, 0.8);
        align-items: center;
        justify-content: center;
        z-index: 999;
      " onclick="closeModal('{{ s.solicitud_id }}')">
      <div style="
          background: white;
          padding: 1.5rem;
          max-width: 42rem;
          width: 100%;
          border-radius: 8px;
          position: relative;
        " onclick="event.stopPropagation()">
        <h2 style="font-size: 1.25rem; font-weight: bold; margin-bottom: 1rem">
          Confirmar aceptación
        </h2>

        <!-- selector -->
        <div>
          <label class="block mb-1 text-gray-700 font-semibold">Seleccione respuesta</label>
          <select name="respuesta_solicitud_id"
            class="border-1 border-gray-400 w-full p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            onchange="mostrarRespuesta('{{ s.solicitud_id }}', this)" required>
            <option value="">Seleccione una opción</option>
            {% for r in respuestas_aprobado %}
            <option value="{{ r.respuesta_solicitud_id }}" data-respuesta="{{ r.respuesta }}">
              {{ r.nombre }}
            </option>

            {% endfor %}
          </select>
        </div>

        <div>
          <p id="respuesta-texto-{{ s.solicitud_id }}"
            class="border-1 mt-3 border-gray-400 focus:outline-none w-full p-2 rounded-lg text-center"></p>
        </div>

        <div id="placeholders-{{ s.solicitud_id }}" class="mt-3 space-y-2"></div>

        <div class="js-mail-editor rounded-lg border border-dashed w-full h-36 my-3 flex justify-center items-center overflow-y-auto" contenteditable="true"
          class="rounded-lg border border-dashed w-full h-36 my-3 flex justify-center items-center overflow-y-auto">
          <!-- <input type="file" class="cursor-pointer"> -->
        </div>

        <div style="
            margin-top: 1rem;
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
          ">
          <button type="button" onclick="closeModal('{{ s.solicitud_id }}')"
            class="bg-disabled text-white px-4 py-2 rounded-lg cursor-pointer">
            Cancelar
          </button>


          <!-- Enviar aprobación -->
          <form method="post" action="{{ url_for('solicitudes.aprobar', solicitud_id=s.solicitud_id) }}">
            <input type="hidden" name="mensaje" id="mensaje-{{ s.solicitud_id }}" />
            <input type="hidden" name="destinatario" value="{{ s.email }}" />
            <input type="hidden" name="image_data" /> 
            <button type="submit"
              class="bg-success hover:bg-hover-success text-white px-4 py-2 rounded-lg cursor-pointer">
              Enviar
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal Rechazar -->
     <div id="modal-reject-{{ s.solicitud_id }}" class="hidden" style="
        position: fixed;
        inset: 0;
        background-color: rgba(31, 41, 55, 0.8);
        align-items: center;
        justify-content: center;
        z-index: 999;
      " onclick="closeModalReject('{{ s.solicitud_id }}')">
      <div style="
          background: white;
          padding: 1.5rem;
          max-width: 42rem;
          width: 100%;
          border-radius: 8px;
          position: relative;
        " onclick="event.stopPropagation()">
        <h2 style="font-size: 1.25rem; font-weight: bold; margin-bottom: 1rem">
          Enviar Rechazo de Solicitud
        </h2>

        <!-- selector -->
        <div>
          <label class="block mb-1 text-gray-700 font-semibold">Seleccione respuesta</label>
          <select name="respuesta_solicitud_id"
            class="border-1 border-gray-400 w-full p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            onchange="mostrarRespuestaRechazadas('{{ s.solicitud_id }}', this)" required>
            <option value="">Seleccione una opción</option>
            {% for r in respuesta_desaprobado %}
            <option value="{{ r.respuesta_solicitud_id }}" data-respuesta="{{ r.respuesta }}">
              {{ r.nombre }}
            </option>

            {% endfor %}
          </select>
        </div>

        <div>
          <p id="respuesta-texto-rechazada-{{ s.solicitud_id }}"
            class="border-1 mt-3 border-gray-400 focus:outline-none w-full p-2 rounded-lg text-center"></p>
        </div>

        <div id="placeholders-reject-{{ s.solicitud_id }}" class="mt-3 space-y-2"></div>

        <div class="js-mail-editor rounded-lg border border-dashed w-full h-36 my-3 flex justify-center items-center overflow-y-auto" contenteditable="true"
          class="rounded-lg border border-dashed w-full h-36 my-3 flex justify-center items-center overflow-y-auto">
        </div>

        <div style="
            margin-top: 1rem;
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
          ">
          <button type="button" onclick="closeModal('{{ s.solicitud_id }}')" class="bg-disabled text-white px-4 py-2 rounded-lg cursor-pointer">
            Cancelar
          </button>

          <!-- Enviar rechazo -->
          <form method="post" action="{{ url_for('solicitudes.desaprobar', solicitud_id=s.solicitud_id) }}">
            <input type="hidden" name="mensaje" id="mensaje-rechazo-{{ s.solicitud_id }}" />
            <input type="hidden" name="destinatario" value="{{ s.email }}" />
            <input type="hidden" name="image_data" /> 

            <button type="submit" class="bg-success hover:bg-hover-success text-white px-4 py-2 rounded-lg cursor-pointer">
              Enviar
            </button>
          </form>
        </div>
      </div>
    </div>


    {% endfor %}
  </div>

  <!-- pagination -->
  {% if total_pages > 1 %}
  <div class="mt-4 flex items-center justify-between">
    <div class="text-sm text-dark-300">
      Mostrando
      <span class="font-semibold"> {{ (page-1) * per_page + 1 }} </span>
      –
      <span class="font-semibold">
        {{ (page-1) * per_page + solicitudes|length }}
      </span>
      de
      <span class="font-semibold">{{ total }}</span>
    </div>

    <div class="inline-flex gap-2">
      {% set prev_page = page - 1 %} {% set next_page = page + 1 %}
      <div
        class="border flex rounded-lg justify-center items-center px-3 py-2 gap-1 text-ligth-500 bg-primary-300 {{ 'opacity-50 pointer-events-none' if page <= 1 }}">
        <span class="material-symbols-outlined">
          arrow_left_alt
        </span>
        <a href="{{ url_for('solicitudes.listar_solicitudes', page=page-1, per_page=per_page, **qs) }}">
          Anterior
        </a>
      </div>

      <span class="px-3 py-1 flex justify-center items-center text-dark-500">Página {{ page }} / {{ total_pages
        }}</span>

      <div
        class="border flex rounded-lg justify-center items-center px-3 py-2 gap-1 text-ligth-500 bg-primary-300  {{ 'opacity-50 pointer-events-none' if page >= total_pages }}">
        <a href="{{ url_for('solicitudes.listar_solicitudes', page=page+1, per_page=per_page, **qs) }}">
          Siguiente
        </a>
        <span class="material-symbols-outlined">
          arrow_right_alt
        </span>
      </div>

    </div>
  </div>
  {% endif %}
</div>

<script>

  function openModal(id) {
    document.getElementById(`modal-${id}`).style.display = "flex";
  }
  
  function closeModal(id) {
    const modal= document.getElementById(`modal-${id}`) 
    if (!modal) return;

  // 1) Resetear selector a "Seleccione una opción"
  const select = modal.querySelector('select[name="respuesta_solicitud_id"]');
  if (select) select.selectedIndex = 0; // vuelve al primer <option>

  // 2) Limpiar el preview del mensaje (aprobación)
  const preview = document.getElementById(`respuesta-texto-${id}`);
  if (preview) preview.textContent = '';

  // 3) (si alguna vez generas placeholders en aprobación) limpiarlos
  const placeholders = document.getElementById(`placeholders-${id}`);
  if (placeholders) placeholders.innerHTML = '';

  // 4) Limpiar editor e imagen
  const editor = modal.querySelector('.js-mail-editor');
  if (editor) editor.innerHTML = '';

  const hiddenImg = modal.querySelector('input[name="image_data"]');
  if (hiddenImg) hiddenImg.value = '';

  // 5) Limpiar mensaje oculto (si lo usas)
  const hiddenMsg = document.getElementById(`mensaje-${id}`);
  if (hiddenMsg) hiddenMsg.value = '';

  // 6) Cerrar modal
  modal.style.display = "none";
  }

  function getPlaceholders(template) {
    const re = /\{([^}]+)\}/g,
      set = new Set();
    let m;
    while ((m = re.exec(template)) !== null) set.add(m[1].trim());
    return Array.from(set);
  }
  
  function buildText(template, values) {
    return template.replace(
      /\{([^}]+)\}/g,
      (_, k) => values[k.trim()] ?? `{${k}}`
    );
  }

  function mostrarRespuesta(solicitudId, selectEl) {
    const texto = selectEl.selectedOptions[0]?.dataset?.respuesta || "";

    document.getElementById(`respuesta-texto-${solicitudId}`).textContent =
      texto;

    const hiddenMsgSuccess = document.getElementById(`mensaje-${solicitudId}`);

    function refresh() {
      const finalText = buildText(texto);

      hiddenMsgSuccess.value = finalText; // <- aquí mandamos el mensaje al backend
    }

    refresh(); // primera carga
  }

  function mostrarRespuestaRechazadas(solicitudId, selectEl) {
    const template = selectEl.selectedOptions[0]?.dataset?.respuesta || "";

    const placeholders = getPlaceholders(template);

    const cont = document.getElementById(`placeholders-reject-${solicitudId}`);
    const previewEl = document.getElementById(
      `respuesta-texto-rechazada-${solicitudId}`
    );
    const hiddenMsg = document.getElementById(`mensaje-rechazo-${solicitudId}`);

    cont.innerHTML = "";
    placeholders.forEach((ph) => {
      const div = document.createElement("div");
      div.className = "flex flex-col gap-1";
      div.innerHTML = `
        <label class="block mb-1 text-gray-700 font-semibold">${ph}</label>
        <input type="text" class="border-1 border-gray-400 focus:outline-none w-full p-2 rounded-lg" data-key="${ph}">
      `;
      cont.appendChild(div);
    });

    function refresh() {
      const values = {};
      cont
        .querySelectorAll("input[data-key]")
        .forEach((inp) => (values[inp.dataset.key] = inp.value.trim()));
      const finalText = buildText(template, values);

      previewEl.textContent = finalText;
      hiddenMsg.value = finalText; // <- aquí mandamos el mensaje al backend
    }

    cont.oninput = refresh;
    refresh(); // primera carga
  }

  function openModalReject(id) {
    document.getElementById(`modal-reject-${id}`).style.display = "flex";
  }
  
  function closeModalReject(id) {
const modal = document.getElementById(`modal-reject-${id}`);
  if (!modal) return;

  // 1) Resetear selector
  const select = modal.querySelector('select[name="respuesta_solicitud_id"]');
  if (select) select.selectedIndex = 0;

  // 2) Limpiar preview y placeholders (rechazo)
  const preview = document.getElementById(`respuesta-texto-rechazada-${id}`);
  if (preview) preview.textContent = '';

  const placeholders = document.getElementById(`placeholders-reject-${id}`);
  if (placeholders) placeholders.innerHTML = '';

  // 3) Limpiar editor e imagen
  const editor = modal.querySelector('.js-mail-editor');
  if (editor) editor.innerHTML = '';

  const hiddenImg = modal.querySelector('input[name="image_data"]');
  if (hiddenImg) hiddenImg.value = '';

  // 4) Limpiar mensaje oculto
  const hiddenMsg = document.getElementById(`mensaje-rechazo-${id}`);
  if (hiddenMsg) hiddenMsg.value = '';

  // 5) Cerrar modal
  modal.style.display = "none";
  }

   // 1) Convierte un File (imagen) a un Data URL (Base64)
  function fileToDataURL(file) {
    return new Promise((resolve, reject) => {
      const fr = new FileReader();
      // Cuando termina de leer, fr.result contiene: "data:image/png;base64,AAAA..."
      fr.onload = () => resolve(fr.result);
      fr.onerror = reject;
      fr.readAsDataURL(file);// Lee el archivo como Data URL
    });
  }

  // 2) Conecta eventos de pegar y arrastrar/soltar a un editor
  //    y guarda el resultado en un <input type="hidden" name="image_data">
  //    que está dentro del mismo modal.
  function attachImageHandlers(editor) {
    // Ubicamos el "modal padre" del editor, para no mezclar inputs entre modales
    // Busca un ancestro cuyo id empiece con "modal" (p.ej. "modal-123" o "modal-reject-45")
    const modal = editor.closest('[id^="modal"]');
    if (!modal) return;
    // Dentro del modal, buscamos el input hidden que almacenará el Base64 de la imagen
    const hidden = modal.querySelector('input[name="image_data"]');
    if (!hidden) return;

   // --- PEGAR (Ctrl+V) una imagen dentro del editor ---
    editor.addEventListener('paste', async (e) => {
      // Clipboard puede traer varios items; buscamos el que sea imagen
      const items = e.clipboardData?.items || [];
      for (const it of items) {
        if (it.kind === 'file' && it.type.startsWith('image/')) {
          e.preventDefault();
          const file = it.getAsFile();
          const dataURL = await fileToDataURL(file);// Convertimos a Base64

          // Mostramos una previsualización dentro del editor
          const img = document.createElement('img');
          img.src = dataURL;
          img.style.maxWidth = '100%';
          img.style.height = 'auto';
          editor.appendChild(img);

          // Guardamos el Base64 en el hidden, listo para enviar al backend
          hidden.value = dataURL; // listo para enviar
          break; // Solo tomamos la primera imagen
        }
      }
    });

     // --- Permite arrastrar encima del editor sin que el navegador abra el archivo ---
    editor.addEventListener('dragover', (e) => e.preventDefault());
     // --- Suelta/Drop de una imagen dentro del editor ---
    editor.addEventListener('drop', async (e) => {
      e.preventDefault();
      const file = e.dataTransfer?.files?.[0];// Tomamos el primer archivo soltado
      if (file && file.type.startsWith('image/')) {
        const dataURL = await fileToDataURL(file);

         // Mostramos la imagen en el editor
        const img = document.createElement('img');
        img.src = dataURL;
        img.style.maxWidth = '100%';
        img.style.height = 'auto';
        editor.appendChild(img);

        // Guardamos el Base64 para el envío por formulario
        hidden.value = dataURL;
      }
    });
  }

  // Bind genérico a TODOS los editores de todos los modales
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.js-mail-editor').forEach(attachImageHandlers);
  });



</script>

{% endblock %}