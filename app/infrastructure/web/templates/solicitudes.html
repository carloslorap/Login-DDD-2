{% extends 'layout/base.html' %} {% block title %}Solicitudes{% endblock %} {%
block content %}

<div class="max-w-7xl mx-auto bg-white shadow-lg rounded-lg p-6">
  <h1 class="text-2xl font-bold text-gray-800 mb-4">
    Solicitudes de Citas Médicas
  </h1>

  <div class="overflow-x-auto">
    <form method="get" class="mb-4 flex gap-2">
      <input
        type="text"
        name="nombre"
        placeholder="Buscar por nombre"
        class="border px-2 py-1"
      />
      <input type="date" name="fecha_inicio" class="border px-2 py-1" />
      <input type="date" name="fecha_fin" class="border px-2 py-1" />
      <input type="radio" id="procesados" name="atendidos" class="border px-2 py-1" /> 
      <label for="procesados" name="atendidos" >Mostrar Procesados</label>
      <button type="submit" class="bg-blue-500 text-white px-4 py-1 rounded cursor-pointer">
        Filtrar
      </button>
      <a href="/solicitudes" class="bg-blue-500 text-white px-4 py-1 rounded cursor-pointer flex justify-center items-center">
        Refrescar 
      </a>
    </form>

    <table class="min-w-full border border-gray-200">
      <thead class="bg-gray-100">
        <tr>
          <!-- <th class="px-4 py-2 border">ID</th> -->
          <th class="px-36 py-2 border">Nombres</th>
          <th class="px-4 py-2 border">Especialidad</th>
          <th class="px-4 py-2 border">Documento</th>
          <th class="px-4 py-2 border">Email</th>
          <th class="px-4 py-2 border">Teléfono</th>
          <th class="px-4 py-2 border">Continuador</th>
          <th class="px-4 py-2 border">SIS</th>
          <th class="px-4 py-2 border">Interconsulta</th>
          <th class="px-4 py-2 border">Estado</th>
          <th class="px-4 py-2 border">Fecha</th>
          <th class="px-4 py-2 border">Opciones</th>
        </tr>
      </thead>
      <tbody>
        {% for solicitud in solicitudes %}
        <tr class="hover:bg-gray-50">
          <!-- <td class="px-4 py-2 border">{{ solicitud.solicitud_id }}</td> -->
          <td class="px-4 py-2 border">{{ solicitud.nombres }}</td>
          <td class="px-4 py-2 border">{{ solicitud.especialidad_nombre }}</td>
          <td class="px-4 py-2 border">{{ solicitud.numero_documento }}</td>
          <td class="px-4 py-2 border">{{ solicitud.email }}</td>
          <td class="px-4 py-2 border">{{ solicitud.telefono }}</td>
          <td class="px-4 py-2 border text-center">
            {% if solicitud.continuador == 1 %} SI {% else %} NO {% endif %}
          </td>
          <td class="px-4 py-2 border text-center">
            {% if solicitud.sis %} SI {% else %} NO {% endif %}
          </td>
          <td class="px-4 py-2 border text-center">
            {% if solicitud.interconsulta %} SI {% else %} NO {% endif %}
          </td>
          <td class="px-4 py-2 border text-center">
            {% if solicitud.estado_solicitud_id == 1 %} PENDIENTE {% elif
            solicitud.estado_solicitud_id == 2 %} ACEPTADO {% elif
            solicitud.estado_solicitud_id == 3 %} RECHAZADO {% endif %}
          </td>
          <td class="px-4 py-2 border">
            {{ solicitud.created_at.strftime('%d/%m/%Y') if solicitud.created_at
            else '' }}
          </td>
          <td
            class="px-4 py-3.5 border flex justify-between items-center gap-2"
          >
            {% if solicitud.estado_solicitud_id == 2 or
            solicitud.estado_solicitud_id == 3%}
            <button
              type="button"
              class="border p-2 bg-gray-400 text-white cursor-not-allowed"
              disabled
            >
              Aceptar
            </button>

            <button
              type="button"
              class="border p-2 bg-gray-400 text-white cursor-not-allowed"
              disabled
            >
              Rechazar
            </button>
            {% elif solicitud.estado_solicitud_id == 1 %}
            <button
              type="button"
              class="border p-2 bg-green-400 text-white cursor-pointer"
              onclick="openModal('{{ solicitud.solicitud_id }}')"
            >
              Aceptar
            </button>

            <button
              type="button"
              class="border p-2 bg-red-400 text-white cursor-pointer"
              onclick="openModalReject('{{ solicitud.solicitud_id }}')"
            >
              Rechazar
            </button>
            {% endif %}
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="11" class="text-center py-4 text-gray-500">
            No hay solicitudes registradas.
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    {% for s in solicitudes %}
    <!-- Modal Aceptar -->
    <div
      id="modal-{{ s.solicitud_id }}"
      class="hidden"
      style="
        position: fixed;
        inset: 0;
        background-color: rgba(31, 41, 55, 0.8);
        align-items: center;
        justify-content: center;
        z-index: 999;
      "
      onclick="closeModal('{{ s.solicitud_id }}')"
    >
      <div
        style="
          background: white;
          padding: 1.5rem;
          max-width: 32rem;
          width: 100%;
          border-radius: 8px;
          position: relative;
        "
        onclick="event.stopPropagation()"
      >
        <h2 style="font-size: 1.25rem; font-weight: bold; margin-bottom: 1rem">
          Confirmar aceptación
        </h2>

        <!-- selector -->
        <div>
          <label class="block mb-1 text-gray-700 font-semibold"
            >Seleccione respuesta</label
          >
          <select
            name="respuesta_solicitud_id"
            class="border-1 border-gray-400 w-full p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            onchange="mostrarRespuesta('{{ s.solicitud_id }}', this)"
            required
          >
            <option value="">Seleccione una opción</option>
            {% for r in respuestas_aprobado %}
            <option
              value="{{ r.respuesta_solicitud_id }}"
              data-respuesta="{{ r.respuesta }}"
            >
              {{ r.nombre }}
            </option>

            {% endfor %}
          </select>
        </div>

        <div>
          <p
            id="respuesta-texto-{{ s.solicitud_id }}"
            class="border-1 mt-3 border-gray-400 focus:outline-none w-full p-2 rounded-lg text-center"
          ></p>
        </div>

        <div
          id="text-area"
          contenteditable="true"
          onInput="change(this)"
          class="rounded-lg border border-dashed w-full h-36 my-3 flex justify-center items-center overflow-y-auto"
        >
          <!-- <input type="file" class="cursor-pointer"> -->
        </div>

        <div
          style="
            margin-top: 1rem;
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
          "
        >
          <button
            type="button"
            onclick="closeModal('{{ s.solicitud_id }}')"
            style="
              background-color: #9ca3af;
              color: white;
              padding: 0.5rem 1rem;
              border-radius: 4px;
            "
          >
            Cancelar
          </button>

          <!-- Enviar aprobación -->
          <form
            method="post"
            action="{{ url_for('solicitudes.aprobar', solicitud_id=s.solicitud_id) }}"
          >
            <button
              type="submit"
              style="
                background-color: #22c55e;
                color: white;
                padding: 0.5rem 1rem;
                border-radius: 4px;
              "
            >
              Confirmar
            </button>
          </form>
        </div>
      </div>
    </div>


      <!-- Modal Rechazar -->
       <div
      id="modal-reject-{{ s.solicitud_id }}"
      class="hidden"
      style="
        position: fixed;
        inset: 0;
        background-color: rgba(31, 41, 55, 0.8);
        align-items: center;
        justify-content: center;
        z-index: 999;
      "
      onclick="closeModalReject('{{ s.solicitud_id }}')"
    >
      <div
        style="
          background: white;
          padding: 1.5rem;
          max-width: 32rem;
          width: 100%;
          border-radius: 8px;
          position: relative;
        "
        onclick="event.stopPropagation()"
      >
        <h2 style="font-size: 1.25rem; font-weight: bold; margin-bottom: 1rem">
          Enviar Rechazo de Solicitud
        </h2>

        <!-- selector -->
        <div>
          <label class="block mb-1 text-gray-700 font-semibold"
            >Seleccione respuesta</label
          >
          <select
            name="respuesta_solicitud_id"
            class="border-1 border-gray-400 w-full p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            onchange="mostrarRespuestaRechazadas('{{ s.solicitud_id }}', this)"
            required
          >
            <option value="">Seleccione una opción</option>
            {% for r in respuesta_desaprobado %}
            <option
              value="{{ r.respuesta_solicitud_id }}"
              data-respuesta="{{ r.respuesta }}"
            >
              {{ r.nombre }}
            </option>

            {% endfor %}
          </select>
        </div>

        <div>
          <p
            id="respuesta-texto-rechazada-{{ s.solicitud_id }}"
            class="border-1 mt-3 border-gray-400 focus:outline-none w-full p-2 rounded-lg text-center"
          ></p>
        </div>

        <div
          id="text-area"
          contenteditable="true"
          onInput="change(this)"
          class="rounded-lg border border-dashed w-full h-36 my-3 flex justify-center items-center overflow-y-auto"
        >
        </div>

        <div
          style="
            margin-top: 1rem;
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
          "
        >
          <button
            type="button"
            onclick="closeModal('{{ s.solicitud_id }}')"
            style="
              background-color: #9ca3af;
              color: white;
              padding: 0.5rem 1rem;
              border-radius: 4px;
            "
          >
            Cancelar
          </button>

          <!-- Enviar rechazo -->
          <form
            method="post"
            action="{{ url_for('solicitudes.desaprobar', solicitud_id=s.solicitud_id) }}"
          >
            <button
              type="submit"
              style="
                background-color: #22c55e;
                color: white;
                padding: 0.5rem 1rem;
                border-radius: 4px;
              "
            >
              Confirmar
            </button>
          </form>
        </div>
      </div>
    </div>



    {% endfor %}
  </div>
</div>

<script>
   function mostrarRespuesta(solicitudId, selectEl) {
    const texto = selectEl.selectedOptions[0]?.dataset?.respuesta || ""; 
    document.getElementById(`respuesta-texto-${solicitudId}`).textContent = texto;
  }

  function mostrarRespuestaRechazadas(solicitudId,selectDel){
    const text = selectDel.selectedOptions[0]?.dataset?.respuesta || ""
    document.getElementById(`respuesta-texto-rechazada-${solicitudId}`).textContent = text
  }


  function openModal(id) {
    document.getElementById(`modal-${id}`).style.display = "flex";
  }
  function closeModal(id) {
    document.getElementById(`modal-${id}`).style.display = "none";

  }

  function openModalReject(id) {
    document.getElementById(`modal-reject-${id}`).style.display = "flex";
  }
  function closeModalReject(id) {
    document.getElementById(`modal-reject-${id}`).style.display = "none";
  }


















  let file = undefined;

  //funcion de la imagen
  function DataURIToBlob(dataURI) {
    const splitDataURI = dataURI.split(",");
    const byteString =
      splitDataURI[0].indexOf("base64") >= 0
        ? atob(splitDataURI[1])
        : decodeURI(splitDataURI[1]);
    const mimeString = splitDataURI[0].split(":")[1].split(";")[0];

    const ia = new Uint8Array(byteString.length);
    for (let i = 0; i < byteString.length; i++)
      ia[i] = byteString.charCodeAt(i);

    return new Blob([ia], { type: mimeString });
  }

  let change = async (target) => {
    let image = target.querySelector("img");
    if (image) {
      file = await DataURIToBlob(image.src);
      console.log(file);
    }
  };
</script>

{% endblock %}
